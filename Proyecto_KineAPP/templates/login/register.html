{% load static %}
{% load tz %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro – KinergiaRoyale</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- CSS Login (mismo archivo que usas en login.html) -->
  <link rel="stylesheet" href="{% static 'css/login.css' %}">

  <!-- Estilos SOLO para los logos en las esquinas (misma lógica que login y seleccionar entrada) -->
  <style>
    .page-logos {
      position: fixed;
      top: 16px;
      left: 24px;
      right: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      pointer-events: none; /* no bloquea clics del formulario */
    }

    .page-logos img {
      height: 225px;   /* ajusta el tamaño aquí si quieres más grande/chico */
      width: auto;
    }
  </style>
</head>

<body>

  <!-- LOGOS ARRIBA IZQ / DER -->
  <div class="page-logos">
      <!-- izquierda: kinesiología -->
      <img src="{% static 'img/logo_kinesiologia.png' %}" alt="Logo Kinesiología">
      <!-- derecha: UCN -->
      <img src="{% static 'img/logo_ucn.png' %}" alt="Logo UCN">
  </div>

  <section class="login-wrapper">

    <div class="login-container">

      <!-- Título -->
      <h1 class="login-title">Registrarse</h1>
      <p class="login-sub">Crea tu cuenta para acceder a la plataforma</p>

      <!-- Mensajes Django -->
      {% if messages %}
        {% for m in messages %}
          <div class="alert-message">{{ m }}</div>
        {% endfor %}
      {% endif %}

      <!-- Formulario Registro -->
      <form method="POST">
        {% csrf_token %}

        <!-- Nombre -->
        <div class="form-group">
          <label>Nombre</label>
          <input
            type="text"
            name="first_name"
            class="form-input"
            required
            pattern="[A-Za-zÁÉÍÓÚÑáéíóúñ\s]+"
            title="Solo se permiten letras y espacios."
          />
        </div>

        <!-- Apellido -->
        <div class="form-group">
          <label>Apellido</label>
          <input
            type="text"
            name="last_name"
            class="form-input"
            required
            pattern="[A-Za-zÁÉÍÓÚÑáéíóúñ\s]+"
            title="Solo se permiten letras y espacios."
          />
        </div>

        <!-- Correo institucional -->
        <div class="form-group">
          <label>Correo institucional</label>
          <input
            type="email"
            name="email"
            class="form-input"
            required
            placeholder="tu.correo@alumnos.ucn.cl"
          />
        </div>

        <!-- RUT -->
        <div class="form-group">
          <label>RUT</label>
          <input
            type="text"
            name="rut"
            class="form-input"
            placeholder="12.345.678-9"
            required
          />
        </div>

        <!-- Usuario -->
        <div class="form-group">
          <label>Usuario</label>
          <input type="text" name="username" class="form-input" required />
        </div>

        <!-- Contraseña -->
        <div class="form-group">
          <label>Contraseña</label>
          <input type="password" name="password1" class="form-input" required />
          <small class="help-text" style="font-size: 0.8rem; color:#555;">
            • No debe asemejarse a tu información personal.<br>
            • Debe contener al menos 8 caracteres.<br>
            • No debe ser una clave utilizada comúnmente.<br>
            • No puede ser completamente numérica.
          </small>
        </div>

        <!-- Confirmar contraseña -->
        <div class="form-group">
          <label>Confirmar Contraseña</label>
          <input type="password" name="password2" class="form-input" required />
        </div>

        <!-- Botón principal -->
        <button type="submit" class="login-btn">Crear Cuenta</button>

        <!-- Link a Login -->
        <div class="register-text">
          ¿Ya tienes cuenta? <a href="{% url 'usuario:login_estudiantes' %}">Inicia sesión</a>
        </div>

      </form>

    </div>

  </section>

  <!-- VALIDACIONES JS (RUT + correo institucional) -->
  <script>
  function validarRUT(rut) {
      rut = rut.replace(/\./g, "").replace(/-/g, "").toUpperCase();
      if (rut.length < 8) return false;

      let cuerpo = rut.slice(0, -1);
      let dv = rut.slice(-1);

      if (!/^\d+$/.test(cuerpo)) return false;

      let suma = 0;
      let multiplo = 2;

      for (let i = cuerpo.length - 1; i >= 0; i--) {
          suma += multiplo * parseInt(cuerpo[i]);
          multiplo = multiplo < 7 ? multiplo + 1 : 2;
      }

      let dvEsperado = 11 - (suma % 11);
      dvEsperado = dvEsperado === 11 ? "0" : dvEsperado === 10 ? "K" : dvEsperado.toString();

      return dv === dvEsperado;
  }

  document.addEventListener("DOMContentLoaded", function () {
      const form = document.querySelector("form");
      const rutInput = document.querySelector("input[name='rut']");
      const emailInput = document.querySelector("input[name='email']");

      form.addEventListener("submit", function (e) {
          const rut = rutInput.value.trim();
          const email = emailInput.value.trim().toLowerCase();

          if (!validarRUT(rut)) {
              e.preventDefault();
              alert("El RUT ingresado no es válido. Verifica el dígito verificador.");
              rutInput.focus();
              return;
          }

          if (!email.endsWith("@alumnos.ucn.cl")) {
              e.preventDefault();
              alert("El correo debe ser institucional (@alumnos.ucn.cl).");
              emailInput.focus();
              return;
          }
      });
  });
  </script>

</body>
</html>
